#!/bin/bash
#
# Writing Mentor Framework CLI
#
# Usage:
#   wmf init              Initialize the current folder with the framework
#   wmf init /path/to    Initialize a specific folder
#   wmf claude           Open Claude Code in the current folder
#   wmf help             Show this help message
#
# Installation:
#   Add this to your shell profile (~/.zshrc or ~/.bashrc):
#   export PATH="$HOME/writing-mentor-framework/bin:$PATH"
#

# Find the framework directory (parent of bin/)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    echo "Writing Mentor Framework CLI"
    echo ""
    echo "Usage:"
    echo "  wmf init [path]     Initialize a folder with the framework (default: current directory)"
    echo "  wmf claude          Open Claude Code in the current folder"
    echo "  wmf help            Show this help message"
    echo ""
    echo "Quick Start:"
    echo "  1. cd /path/to/new/class"
    echo "  2. wmf init"
    echo "  3. Drop in assignment.md, rubric.md, and submissions/"
    echo "  4. wmf claude (or just: claude)"
    echo "  5. Tell Claude: review the submissions"
}

init_folder() {
    local TARGET="${1:-.}"
    TARGET="$(cd "$TARGET" 2>/dev/null && pwd)" || TARGET="$(mkdir -p "$1" && cd "$1" && pwd)"

    echo -e "${BLUE}Initializing Writing Mentor Framework in:${NC}"
    echo "  $TARGET"
    echo ""

    # Run the Python init script
    python3 "$FRAMEWORK_DIR/scripts/init_project.py" --target "$TARGET" --framework "$FRAMEWORK_DIR" --force

    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}========================================${NC}"
        echo -e "${GREEN}Framework initialized successfully!${NC}"
        echo -e "${GREEN}========================================${NC}"
        echo ""
        echo -e "${YELLOW}Next steps:${NC}"
        echo ""
        echo "  1. Edit these files with your assignment details:"
        echo -e "     ${BLUE}assignment.md${NC}  - Assignment requirements"
        echo -e "     ${BLUE}rubric.md${NC}      - Evaluation criteria"
        echo -e "     ${BLUE}course_concepts.md${NC} - Domain concepts (optional)"
        echo ""
        echo "  2. Drop student submissions into:"
        echo -e "     ${BLUE}submissions/${NC}"
        echo ""
        echo "  3. Open Claude Code and review:"
        echo -e "     ${GREEN}cd $TARGET${NC}"
        echo -e "     ${GREEN}claude${NC}"
        echo ""
        echo "  4. In Claude Code, say:"
        echo -e "     ${GREEN}/grade${NC}"
        echo "     or: 'review the submissions'"
        echo ""
    else
        echo -e "${RED}Initialization failed. Check the error messages above.${NC}"
        exit 1
    fi
}

open_claude() {
    if command -v claude &> /dev/null; then
        claude
    else
        echo -e "${RED}Claude Code CLI not found.${NC}"
        echo "Install it from: https://claude.ai/download"
        exit 1
    fi
}

# Main command router
case "${1:-help}" in
    init)
        init_folder "$2"
        ;;
    claude)
        open_claude
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
